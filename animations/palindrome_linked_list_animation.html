<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palindrome Linked List Animation</title>
    <style>
        :root {
            --color-bg-light: #f4f7f6; --color-bg-panel: #ffffff; --color-text-dark: #2c3e50;
            --color-primary: #16a085; --color-success: #27ae60; --color-danger: #c0392b;
            --color-warning: #f39c12; --color-info: #3498db; --color-slow: #8e44ad; --color-fast: #e67e22;
        }
        html, body {
            height: 100%; margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: var(--color-bg-light);
        }
        .dashboard-container {
            display: grid; grid-template-columns: minmax(450px, 1fr) 2.5fr;
            grid-template-rows: auto 1fr; grid-template-areas: "header header" "left main";
            gap: 15px; padding: 15px; height: 100%; box-sizing: border-box;
        }
        .panel { background-color: var(--color-bg-panel); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 15px; display: flex; flex-direction: column; min-height: 0; }
        h1, h2 { color: var(--color-text-dark); text-align: center; margin-top: 0; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee;}
        h1 { font-size: 1.5em; border: none; } h2 { font-size: 1.1em; }

        .header { grid-area: header; }
        .controls { display: flex; flex-wrap: wrap; gap: 15px; padding: 10px; background-color: #e8f6f3; border-radius: 5px; align-items: center; justify-content: center;}
        .controls input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Courier New', monospace; width: 400px; }
        .controls button { padding: 10px 15px; background-color: var(--color-primary); color: white; border: none; border-radius: 4px; cursor: pointer; }
        .controls button:disabled { background-color: #bdc3c7; }

        .left-column { grid-area: left; display: grid; grid-template-rows: 1fr auto; gap: 15px; min-height: 0; }
        .main-column { grid-area: main; }
        
        #code_container { background: #2d2d2d; color: #f1f1f1; font-family: 'Courier New', monospace; font-size: 0.8em; flex-shrink: 1; overflow-y: auto;}
        .code-line { padding: 2px 5px; border-radius: 3px; transition: background-color 0.3s; }
        .code-line.highlight { background-color: #555; }
        #action_display { text-align: center; font-weight: bold; font-size: 1.1em; background: #f8f9fa; padding: 8px; border-radius: 4px; }
        
        #viz_container { width: 100%; height: 100%; overflow: auto; }
        #viz_svg .node circle { stroke-width: 2px; }
        #viz_svg .node text { font-size: 18px; fill: white; text-anchor: middle; dominant-baseline: central; font-weight: bold; pointer-events: none; }
        #viz_svg .node .first-half { fill: var(--color-info); stroke: #2980b9; }
        #viz_svg .node .second-half { fill: var(--color-slow); stroke: #7d3c98; }
        #viz_svg .node-link { stroke: #34495e; stroke-width: 2.5px; fill: none; transition: all 0.5s ease; }
        #viz_svg .node-link.reversed { stroke: var(--color-danger); }
        #viz_svg .pointer { transition: transform 0.5s ease; }
        #viz_svg .pointer text { font-family: 'Courier New', monospace; font-size: 16px; font-weight: bold; text-anchor: middle; }
        #viz_svg .node .match { animation: flash-green 0.8s; }
        #viz_svg .node .mismatch { animation: flash-red 0.8s; }
        @keyframes flash-green { 50% { fill: var(--color-success); } }
        @keyframes flash-red { 50% { fill: var(--color-danger); } }
        
        #comparison_box { text-align: center; font-family: 'Courier New', monospace; font-size: 1.5em; padding: 10px; visibility: hidden; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; }
        #final_result_text { font-size: 1.8em; font-weight: bold; margin: 20px 0; }
        #final_result_text.true { color: var(--color-success); }
        #final_result_text.false { color: var(--color-danger); }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="header panel"><h1>Palindrome Linked List</h1>
            <div class="controls">
                <label>List (e.g., 1,2,2,1):</label><input id="list_input" type="text" value="1,2,3,2,1">
                <button id="start_button">Start</button><button id="next_step_button" disabled>Next Step</button>
            </div>
        </header>
        <div class="left-column">
            <div class="panel"><h2>Algorithm</h2><div id="code_container"></div></div>
            <div class="panel" style="flex-grow: 0; flex-shrink: 0;"><h2>Current Action</h2>
                <div id="action_display">Enter data and click 'Start'.</div>
                <div id="comparison_box"></div>
            </div>
        </div>
        <main class="main-column panel"><div id="viz_container"><svg id="viz_svg" width="100%" height="100%"></svg></div></main>
    </div>
    <div id="result_modal" class="modal-overlay">
         <div class="modal-content">
            <h2>Final Result</h2><p id="final_result_text"></p>
            <button id="modal_close_btn" class="controls button">Close</button>
        </div>
    </div>

<script>
class AnimationController {
    constructor() {
        this.listInput = document.getElementById('list_input');
        this.startButton = document.getElementById('start_button');
        this.nextStepButton = document.getElementById('next_step_button');
        this.codeContainer = document.getElementById('code_container');
        this.actionDisplay = document.getElementById('action_display');
        this.svg = document.getElementById('viz_svg');
        this.comparisonBox = document.getElementById('comparison_box');
        this.animationSteps = []; this.currentStepIndex = 0; this.simulationRunning = false;
        
        this.startButton.addEventListener('click', () => this.start());
        this.nextStepButton.addEventListener('click', () => this.next());
        document.getElementById('modal_close_btn').addEventListener('click', () => {
            document.getElementById('result_modal').style.display = 'none';
        });
    }

    reset() {
        this.animationSteps = []; this.currentStepIndex = 0; this.simulationRunning = false;
        this.updateButtons();
        this.actionDisplay.textContent = 'Enter data and click \'Start\'.';
        this.svg.innerHTML = '';
        if (this.codeContainer) this.codeContainer.innerHTML = '';
        if (this.comparisonBox) this.comparisonBox.style.visibility = 'hidden';
        const modal = document.getElementById('result_modal');
        if (modal) modal.style.display = 'none';
    }

    start() {
        this.reset();
        try {
            const listStr = this.listInput.value.trim();
            const nums = listStr ? listStr.split(',').map(s => Number(s.trim())) : [];
            if (listStr && !/^(\d+)(,\s*\d+)*$/.test(listStr)) {
                throw new Error("Invalid input. Use comma-separated numbers.");
            }
            this.initUI();
            this.animationSteps = this.generateSteps(nums);
            this.simulationRunning = true;
            if (this.animationSteps.length > 0) this.renderState(this.animationSteps[0]);
            this.updateButtons();
        } catch (e) {
            alert("Error: " + e.message);
        }
    }

    next() {
        if (!this.simulationRunning || this.currentStepIndex >= this.animationSteps.length - 1) return;
        this.currentStepIndex++;
        this.renderState(this.animationSteps[this.currentStepIndex]);
        this.updateButtons();
    }
    
    updateButtons() {
        this.startButton.textContent = this.simulationRunning ? "Reset" : "Start";
        this.nextStepButton.disabled = !this.simulationRunning || this.currentStepIndex >= this.animationSteps.length - 1;
    }

    initUI() {
        const code = [
           "// Phase 1: Find middle",
           "slow = head, fast = head",
           "while fast.next != null && fast.next.next != null:",
           "  slow = slow.next",
           "  fast = fast.next.next",
           "// Phase 2: Reverse 2nd half",
           "prev = null, curr = slow.next",
           "while curr != null:",
           "  nextTemp = curr.next",
           "  curr.next = prev",
           "  prev = curr; curr = nextTemp;",
           "// Phase 3: Compare halves",
           "p1 = head, p2 = prev",
           "while p2 != null:",
           "  if p1.val != p2.val: return false",
           "  p1 = p1.next; p2 = p2.next;",
           "return true",
        ];
        this.codeContainer.innerHTML = code.map((line, i) => `<div class="code-line" id="code-line-${i}">${line.replace(/ /g, '&nbsp;')}</div>`).join('');
    }

    generateSteps(nums) {
        const steps = [];
        let nodes = nums.map((val, i) => ({ id: i, val, next: (i === nums.length - 1) ? null : i + 1, half: 1 }));
        
        let state = { line: null, msg: "", nodes: JSON.parse(JSON.stringify(nodes)), pointers: {}, comparison: {p1: '?', p2: '?'}};
        const save = () => steps.push(JSON.parse(JSON.stringify(state)));

        if (!nums || nums.length < 2) {
            state.msg = "List has 0 or 1 node, so it's a palindrome."; state.result = true; save(); return steps;
        }
        
        const findNode = (id) => state.nodes.find(n => n.id === id);

        // Phase 1: Find Middle
        state.line = 0; state.msg = "Phase 1: Find the node before the second half begins."; save();
        let slowId = 0, fastId = 0;
        state.pointers = { slow: 0, fast: 0 };
        state.line = 1; state.msg = "Initialize `slow` and `fast` pointers to the head."; save();
        
        while (true) {
            const fastNode = findNode(fastId);
            const fastNextNode = fastNode ? findNode(fastNode.next) : null;
            const fastNextNextNode = fastNextNode ? findNode(fastNextNode.next) : null;
            
            if (!fastNextNode || !fastNextNextNode) {
                state.line = 2; state.msg = "`fast` can no longer jump two steps. Loop terminates."; save();
                break;
            }
            state.line = 2; state.msg = "`fast` can safely jump two steps. Loop continues."; save();
            
            slowId = findNode(slowId).next;
            fastId = fastNextNextNode.id;
            state.pointers = { slow: slowId, fast: fastId };
            state.line = 3; state.msg = "`slow` moves one step."; save();
            state.line = 4; state.msg = "`fast` moves two steps."; save();
        }
        
        const secondHalfStartId = findNode(slowId).next;
        state.pointers = { slow: slowId };

        // Phase 2: Reverse Second Half
        state.msg = "Phase 2: Reverse the second half of the list."; state.line = 5; save();
        let prevId = null, currId = secondHalfStartId;
        
        let tempId = secondHalfStartId;
        while(tempId !== null) { findNode(tempId).half = 2; tempId = findNode(tempId).next; }

        state.pointers = { prev: prevId, curr: currId };
        state.line = 6; state.msg = "Initialize `prev` to null and `curr` to the start of the second half."; save();

        while (currId !== null) {
            const currNode = findNode(currId);
            state.line = 7; state.msg = `Loop starts. \`curr\` (Node ${currNode.val}) is not null.`; save();
            
            const nextTempId = currNode.next;
            state.pointers = { prev: prevId, curr: currId, nextTemp: nextTempId };
            state.line = 8; state.msg = "Store `curr.next` in `nextTemp`."; save();

            currNode.next = prevId;
            state.line = 9; state.msg = "Reverse pointer: `curr.next` now points to `prev`."; save();

            prevId = currId;
            currId = nextTempId;
            state.pointers = { prev: prevId, curr: currId };
            state.line = 10; state.msg = "Advance `prev` and `curr` pointers."; save();
        }
        state.line = 7; state.msg = "`curr` is now null. Second half is reversed."; save();
        
        // Phase 3: Compare
        let p1Id = 0, p2Id = prevId;
        state.pointers = { p1: p1Id, p2: p2Id };
        state.line = 12; state.msg = "Phase 3: Compare the first half with the reversed second half."; save();

        while (p2Id !== null) {
            state.line = 13; state.msg = "`p2` is not null. Loop continues."; save();
            const p1Node = findNode(p1Id);
            const p2Node = findNode(p2Id);
            state.comparison = { p1: p1Node.val, p2: p2Node.val };

            if (p1Node.val !== p2Node.val) {
                state.pointers.p1_mismatch = p1Id; state.pointers.p2_mismatch = p2Id;
                state.line = 14; state.msg = `Mismatch! ${p1Node.val} != ${p2Node.val}. Not a palindrome.`;
                state.result = false; save(); return steps;
            }
            state.pointers.p1_match = p1Id; state.pointers.p2_match = p2Id;
            state.line = 14; state.msg = `Match! ${p1Node.val} == ${p2Node.val}.`; save();
            
            p1Id = p1Node.next;
            p2Id = p2Node.next;
            state.pointers = { p1: p1Id, p2: p2Id };
            state.line = 15; state.msg = "Advance both pointers."; save();
            state.pointers.p1_match = null; state.pointers.p2_match = null;
        }
        state.line = 13; state.msg = "`p2` is null. All nodes matched.";
        state.result = true; save();
        state.line = 16; state.msg = "It's a palindrome! Return true."; save();
        
        return steps;
    }

    renderState(state) {
        this.actionDisplay.textContent = state.msg;
        this.codeContainer.querySelectorAll('.code-line').forEach(el => el.classList.remove('highlight'));
        if (state.line !== null) document.getElementById(`code-line-${state.line}`)?.classList.add('highlight');
        
        this.svg.innerHTML = '';
        const nodeRadius = 30, nodeSpacing = 100, listY = 150;
        
        const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
        const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
        marker.setAttribute('id', 'arrowhead'); marker.setAttribute('viewBox', '-0 -5 10 10');
        marker.setAttribute('refX', 10); marker.setAttribute('refY', 0);
        marker.setAttribute('orient', 'auto'); marker.setAttribute('markerWidth', 5);
        marker.setAttribute('markerHeight', 5);
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute('d', 'M0,-5L10,0L0,5'); path.setAttribute('fill', '#34495e');
        marker.appendChild(path); defs.appendChild(marker); this.svg.appendChild(defs);
        
        const nodePositions = {};
        state.nodes.forEach((node, i) => nodePositions[node.id] = { x: 50 + (i + 1) * nodeSpacing, y: listY });
        
        // Draw Links
        state.nodes.forEach(node => {
            if (node.next !== null && nodePositions[node.id] && nodePositions[node.next]) {
                const startPos = nodePositions[node.id]; const endPos = nodePositions[node.next];
                const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
                const isReversed = endPos.x < startPos.x;
                const angle = Math.atan2(endPos.y - startPos.y, endPos.x - startPos.x);
                const startX = startPos.x + Math.cos(angle) * nodeRadius;
                const startY = startPos.y + Math.sin(angle) * nodeRadius;
                const endX = endPos.x - Math.cos(angle) * nodeRadius;
                const endY = endPos.y - Math.sin(angle) * nodeRadius;
                const yOffset = isReversed ? 60 : -40;
                const d = `M ${startX} ${startY} C ${startX + nodeSpacing/2} ${startY + yOffset}, ${endX - nodeSpacing/2} ${endY + yOffset}, ${endX} ${endY}`;
                p.setAttribute('d', d); p.classList.add('node-link');
                if (isReversed) p.classList.add('reversed');
                p.setAttribute('marker-end', 'url(#arrowhead)'); this.svg.appendChild(p);
            }
        });
        
        // Draw Nodes
        state.nodes.forEach(node => {
            const pos = nodePositions[node.id];
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.classList.add('node');
            if(node.id === state.pointers.p1_match || node.id === state.pointers.p2_match) g.classList.add('match');
            if(node.id === state.pointers.p1_mismatch || node.id === state.pointers.p2_mismatch) g.classList.add('mismatch');
            const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            circle.setAttribute('cx', pos.x); circle.setAttribute('cy', pos.y); circle.setAttribute('r', nodeRadius);
            circle.classList.add(node.half === 1 ? 'first-half' : 'second-half');
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute('x', pos.x); text.setAttribute('y', pos.y);
            text.textContent = node.val;
            g.appendChild(circle); g.appendChild(text); this.svg.appendChild(g);
        });

        // Draw Pointers
        const pointerColors = { slow: 'var(--color-slow)', fast: 'var(--color-fast)', prev: '#c0392b', curr: '#27ae60', nextTemp: '#f39c12', p1: 'var(--color-danger)', p2: 'var(--color-success)' };
        let pointerYOffset = 60;
        Object.entries(state.pointers).forEach(([name, id]) => {
            if (id === null || id === undefined || !nodePositions[id] || name.includes('_match') || name.includes('_mismatch')) return;
            const pos = nodePositions[id];
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.classList.add('pointer');
            g.setAttribute('transform', `translate(${pos.x}, ${pos.y + pointerYOffset})`);
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute('d', `M0,${nodeRadius + 5} l-7,10 h14 z`);
            path.setAttribute('fill', pointerColors[name] || '#34495e');
            const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
            text.setAttribute('y', nodeRadius + 28);
            text.textContent = name; text.setAttribute('fill', pointerColors[name] || '#34495e');
            g.appendChild(path); g.appendChild(text); this.svg.appendChild(g);
        });

        if (state.line >= 13 && state.pointers.p2 !== null) {
            this.comparisonBox.style.visibility = 'visible';
            this.comparisonBox.innerHTML = `p1.val (<b>${state.comparison.p1}</b>) == p2.val (<b>${