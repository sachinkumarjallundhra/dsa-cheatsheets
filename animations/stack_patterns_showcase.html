<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Stack Showdown: A Visual Guide to Common Patterns</title>
    <style>
        :root {
            --color-bg-light: #f4f7f6; --color-bg-panel: #ffffff; --color-text-dark: #2c3e50;
            --color-primary: #3498db; --color-primary-dark: #2980b9;
            --color-highlight: #f1c40f;
        }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background-color: var(--color-bg-light); display: flex; flex-direction: column; align-items: center; }
        .main-container { width: 98%; max-width: 1400px; background-color: var(--color-bg-panel); border-radius: 8px; box-shadow: 0 0 20px rgba(0,0,0,0.1); overflow: hidden; }
        .main-header { padding: 20px; background-color: var(--color-primary); color: white; text-align: center; }
        .main-header h1 { margin: 0; font-size: 2em; }
        .main-header p { margin: 5px 0 0; opacity: 0.9; }
        
        .tab-nav { display: flex; background-color: #ecf0f1; }
        .tab-button { flex: 1; padding: 15px; background: none; border: none; font-size: 1.1em; font-weight: bold; cursor: pointer; color: var(--color-text-dark); border-bottom: 3px solid transparent; transition: all 0.2s ease; }
        .tab-button:hover { background-color: #e0e6e8; }
        .tab-button.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
        
        .tab-content { display: none; padding: 20px; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .pattern-header { text-align: center; margin-bottom: 20px; }
        .pattern-header h2 { font-size: 1.8em; margin: 0 0 5px 0; color: var(--color-text-dark); }
        .pattern-header .description { font-size: 1.1em; color: #555; max-width: 800px; margin: 0 auto; }
        .pattern-header .problem-link { display: inline-block; margin-top: 10px; font-weight: bold; }

        .anim-controls { display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; padding: 10px; background-color: #e8f0fe; border-radius: 5px; align-items: center; justify-content: center; }
        .anim-controls label { font-weight: bold; margin-right: 5px; }
        .anim-controls input, .anim-controls textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 1.1em; }
        .anim-controls button { padding: 10px 15px; background-color: var(--color-primary); color: white; border: none; border-radius: 4px; cursor: pointer; }
        .anim-controls button:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        .anim-main-content { display: grid; grid-template-columns: 400px 1fr; gap: 15px; }
        .anim-panel { padding: 15px; background-color: #fdfdfd; border: 1px solid #e0e0e0; border-radius: 5px; }
        .anim-panel h3 { text-align: center; margin-top: 0; color: #34495e; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .action-display { text-align: center; font-weight: bold; min-height: 3em; font-size: 1.1em; padding: 10px; background: #f8f9fa; border-radius: 5px; display: flex; align-items: center; justify-content: center; }

        .stack-viz { min-height: 200px; background-color: #f9f9f9; border-radius: 4px; border: 1px solid #ddd; padding: 5px; display: flex; flex-direction: column-reverse; justify-content: flex-start; gap: 5px; }
        .stack-item { padding: 8px; border-radius: 4px; font-family: 'Courier New', monospace; font-weight: bold; text-align: center; border: 2px solid; color: white; transition: all 0.3s ease; animation: push-anim 0.3s ease; }
        @keyframes push-anim { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        
        .string-display { display: flex; flex-wrap: wrap; gap: 4px; padding: 10px; background: #f0f0f0; border-radius: 5px; font-size: 1.5em; font-family: 'Courier New', monospace; }
        .char-box { padding: 2px 8px; border-radius: 3px; transition: background-color 0.3s, color 0.3s; }
        .char-box.highlight { background-color: var(--color-highlight); color: black; box-shadow: 0 0 10px var(--color-highlight); }

        .result-array-container { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .res-cell { width: 50px; height: 50px; background-color: #fff; border: 1px solid #ccc; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 4px; transition: all 0.3s ease; }
        .res-cell .res-value { font-size: 1.5em; font-weight: bold; } .res-cell .res-index { font-size: 0.7em; }
        .res-cell.filled { background-color: #e8f5e9; border-color: #2ecc71; transform: scale(1.1); }
        
        .state-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; margin-top: 15px;}
        .state-item .label { font-size: 0.9em; color: #6c757d; }
        .state-item .value { font-size: 2em; font-weight: bold; font-family: 'Courier New', monospace; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .overlay.show { opacity: 1; pointer-events: auto;}
        .result-box { background: white; padding: 30px 50px; border-radius: 10px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .result-box h2 { font-size: 1.5em; margin: 0 0 10px 0; color: #555;}
        .result-box p { margin: 0; font-size: 2em; color: var(--color-text-dark); font-family: 'Courier New', monospace; font-weight: bold; }

        #ms_viz_container { position: relative; padding: 10px; border-radius: 5px; }
        #ms_bar_chart_container { display: flex; align-items: flex-end; gap: 10px; border-bottom: 3px solid #ccc; padding-bottom: 10px; min-height: 200px; }
        .ms-bar-wrapper { display: flex; flex-direction: column; align-items: center; gap: 5px; width: 45px; }
        .ms-bar { width: 100%; background-color: #bdc3c7; border: 3px solid #7f8c8d; border-bottom: none; border-radius: 5px 5px 0 0; display: flex; justify-content: center; padding-top: 5px; font-weight: bold; transition: all 0.3s ease; }
        .ms-bar.current { border-color: #3498db; } .ms-bar.stack { border-color: #9b59b6; } .ms-bar.popped { border-color: #e67e22; }

        .vp-stack-item { --c-round: #3498db; --c-curly: #9b59b6; --c-square: #27ae60; }
        .vp-stack-item.round { background-color: var(--c-round); border-color: #2980b9; }
        .vp-stack-item.curly { background-color: var(--c-curly); border-color: #8e44ad; }
        .vp-stack-item.square { background-color: var(--c-square); border-color: #229954; }

        #bc_stack_container .result { background-color: #3498db; border-color: #2980b9; }
        #bc_stack_container .sign { background-color: #9b59b6; border-color: #8e44ad; }

        #fnli_input_list_container ul { list-style: none; padding-left: 20px; margin: 4px 0; }
        .fnli-list-item { padding: 4px; margin: 2px 0; border-radius: 4px; border: 1px solid #ccc; transition: all 0.3s; }
        .fnli-list-item.is-list { background-color: #ecf0f1; border-color: #bdc3c7; }
        .fnli-list-item.is-int { background-color: #a9cce3; border-color: #85c1e9; font-weight: bold; }
        .fnli-list-item.highlight { background-color: var(--color-highlight); border-color: #f39c12; transform: scale(1.05); }

        @media (max-width: 1200px) { .anim-main-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="main-container">
    <header class="main-header">
        <h1>The Stack Showdown</h1>
        <p>A Visual Guide to Common Stack Patterns</p>
    </header>

    <nav class="tab-nav">
        <button class="tab-button active" data-tab="monotonic_stack">Monotonic Stack</button>
        <button class="tab-button" data-tab="matching_pairs">Matching Pairs</button>
        <button class="tab-button" data-tab="state_saving">State Saving</button>
        <button class="tab-button" data-tab="iterative_dfs">Iterative DFS</button>
    </nav>
    
    <div id="ms_overlay" class="overlay"><div class="result-box"><h2>Finished!</h2></div></div>
    <div id="vp_overlay" class="overlay"><div class="result-box"><h2 id="vp_final_result"></h2></div></div>
    <div id="bc_overlay" class="overlay"><div class="result-box"><h2>Final Result:</h2><p id="bc_final_result"></p></div></div>
    <div id="fnli_overlay" class="overlay"><div class="result-box"><h2>Finished!</h2><p>Result list is now flattened.</p></div></div>

    <!-- TAB 1: Monotonic Stack -->
    <div id="monotonic_stack_content" class="tab-content active">
        <!-- ... HTML for Tab 1 ... -->
        <div class="pattern-header">
            <h2>Pattern 1: Monotonic Stack</h2>
            <p class="description">
                This pattern is used to find the "next greater" or "previous smaller" element for all items in a sequence. The stack maintains a strictly increasing or decreasing order of elements (or their indices), making comparisons highly efficient.
            </p>
            <a href="https://leetcode.com/problems/next-greater-element-i/" target="_blank" class="problem-link">Example Problem: Next Greater Element</a>
        </div>
        <div class="anim-controls">
            <label>Numbers:</label><input id="ms_input" value="4, 5, 2, 10, 8">
            <button id="ms_start_btn">Start</button>
            <button id="ms_next_btn" disabled>Next Step</button>
        </div>
        <div class="anim-main-content">
            <div class="anim-panel">
                <h3>Stack (of indices)</h3>
                <div id="ms_stack_container" class="stack-viz"></div>
            </div>
            <div class="anim-panel">
                <div id="ms_viz_container">
                    <div id="ms_bar_chart_container"></div>
                    <div class="result-array-container" id="ms_result_container"></div>
                </div>
            </div>
        </div>
        <div class="anim-panel" style="margin-top: 15px;">
            <h3>Current Action</h3>
            <div id="ms_action_display" class="action-display">Enter numbers and click 'Start'.</div>
        </div>
    </div>

    <!-- TAB 2: Matching Pairs -->
    <div id="matching_pairs_content" class="tab-content">
       <!-- ... HTML for Tab 2 ... -->
       <div class="pattern-header">
            <h2>Pattern 2: Matching Pairs</h2>
            <p class="description">
                The quintessential stack use case. When processing a sequence, opening elements are pushed onto the stack. When a closing element appears, it's checked against the top of the stack for a valid match.
            </p>
            <a href="https://leetcode.com/problems/valid-parentheses/" target="_blank" class="problem-link">Example Problem: Valid Parentheses</a>
        </div>
        <div class="anim-controls">
            <label>String:</label><input id="vp_input" value="([{}])">
            <button id="vp_start_btn">Start</button>
            <button id="vp_next_btn" disabled>Next Step</button>
        </div>
        <div class="anim-main-content">
            <div class="anim-panel">
                <h3>Stack</h3>
                <div id="vp_stack_container" class="stack-viz"></div>
            </div>
            <div class="anim-panel">
                 <h3>Input String</h3>
                 <div id="vp_string_display" class="string-display"></div>
            </div>
        </div>
        <div class="anim-panel" style="margin-top: 15px;">
            <h3>Current Action</h3>
            <div id="vp_action_display" class="action-display">Enter a string of brackets and click 'Start'.</div>
        </div>
    </div>

    <!-- TAB 3: State Saving -->
    <div id="state_saving_content" class="tab-content">
        <!-- ... HTML for Tab 3 ... -->
        <div class="pattern-header">
            <h2>Pattern 3: State Saving / Scope Management</h2>
            <p class="description">
                Used in parsing or evaluation problems with nested scopes (like parentheses). The stack saves the state of the outer calculation (e.g., current result, current sign) before diving into an inner scope. When the inner scope is resolved, the state is popped to resume the outer calculation.
            </p>
            <a href="https://leetcode.com/problems/basic-calculator/" target="_blank" class="problem-link">Example Problem: Basic Calculator</a>
        </div>
        <div class="anim-controls">
            <label>Expression:</label><input id="bc_input" value="(1+(4+5)-3)+6">
            <button id="bc_start_btn">Start</button>
            <button id="bc_next_btn" disabled>Next Step</button>
        </div>
        <div class="anim-main-content">
            <div class="anim-panel">
                <h3>State</h3>
                <div class="state-grid" id="bc_state_grid">
                    <div class="state-item"><div class="label">result</div><div id="bc_result_val" class="value">0</div></div>
                    <div class="state-item"><div class="label">sign</div><div id="bc_sign_val" class="value">1</div></div>
                    <div class="state-item"><div class="label">num</div><div id="bc_num_val" class="value">0</div></div>
                </div>
                <h3 style="margin-top:20px;">Stack</h3>
                <div id="bc_stack_container" class="stack-viz"></div>
            </div>
            <div class="anim-panel">
                 <h3>Expression Processing</h3>
                 <div id="bc_string_display" class="string-display"></div>
                 <div id="bc_evaluation_zone" class="anim-panel" style="margin-top:20px; display:none; background-color: #ecf0f1; font-weight:bold; font-family:'Courier New', monospace;"></div>
            </div>
        </div>
        <div class="anim-panel" style="margin-top: 15px;">
            <h3>Current Action</h3>
            <div id="bc_action_display" class="action-display">Enter an expression and click 'Start'.</div>
        </div>
    </div>

    <!-- TAB 4: Iterative DFS -->
    <div id="iterative_dfs_content" class="tab-content">
        <!-- ... HTML for Tab 4 ... -->
        <div class="pattern-header">
            <h2>Pattern 4: Iterative DFS / Recursion Simulation</h2>
            <p class="description">
                A stack can be used to convert a recursive algorithm into an iterative one. This is often done to avoid stack overflow on deep inputs. Instead of making a recursive call, you push the necessary context onto your own stack and process it in a loop.
            </p>
            <a href="https://leetcode.com/problems/flatten-nested-list-iterator/" target="_blank" class="problem-link">Example Problem: Flatten Nested List Iterator</a>
        </div>
        <div class="anim-controls">
            <label>Nested List:</label><input id="fnli_input" value="[[1,1],2,[1,1]]">
            <button id="fnli_start_btn">Start</button>
            <button id="fnli_next_btn" disabled>Next Step</button>
        </div>
        <div class="anim-main-content">
            <div class="anim-panel">
                 <h3>Input Nested List</h3>
                 <div id="fnli_input_list_container"></div>
                 <h3 style="margin-top:20px;">Stack (Simulating Recursion)</h3>
                 <div id="fnli_stack_container" class="stack-viz"></div>
            </div>
            <div class="anim-panel">
                 <h3>Flattened List (Result)</h3>
                 <div id="fnli_result_container" class="result-array-container"></div>
            </div>
        </div>
        <div class="anim-panel" style="margin-top: 15px;">
            <h3>Current Action</h3>
            <div id="fnli_action_display" class="action-display">Enter a nested list (e.g., [1,[4,[6]]]) and click 'Start'.</div>
        </div>
    </div>
</div>

<script>
// --- GLOBAL TAB LOGIC ---
document.addEventListener('DOMContentLoaded', () => {
    const tabs = document.querySelectorAll('.tab-button');
    const contents = document.querySelectorAll('.tab-content');
    const overlays = document.querySelectorAll('.overlay');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab + '_content').classList.add('active');
        });
    });

    overlays.forEach(overlay => {
        overlay.addEventListener('click', () => overlay.classList.remove('show'));
    });

    initMonotonicStack();
    initValidParentheses();
    initBasicCalculator();
    initFlattenNestedList();
});

// --- UTILITY ---
class AnimationModule {
    constructor(prefix) {
        this.prefix = prefix;
        this.steps = [];
        this.currentIndex = 0;
        this.running = false;
        this.dom = {};
        this.generateStepsFn = null;
        this.customResetFn = null;
    }

    get(id) { return document.getElementById(this.prefix + id); }

    setupControls(generateStepsFn, customResetFn, customStartFn = null) {
        this.generateStepsFn = generateStepsFn;
        this.customResetFn = customResetFn;
        this.dom.startBtn = this.get('start_btn');
        this.dom.nextBtn = this.get('next_btn');
        this.dom.input = this.get('input');
        
        const startHandler = customStartFn || this.start.bind(this);
        
        this.dom.startBtn.addEventListener('click', () => {
            if (this.running) this.reset();
            else startHandler();
        });
        this.dom.nextBtn.addEventListener('click', this.next.bind(this));
    }
    
    start() {
        this.resetInternalState();
        this.running = true;
        try {
            this.steps = this.generateStepsFn(this.dom.input.value);
            if (this.steps.length > 0) {
                this.currentIndex = 0;
                this.render(this.steps[0]);
            }
        } catch(e) {
            console.error(`Error during step generation for ${this.prefix}:`, e);
            alert('Invalid input format. Please check your input and try again.');
            this.reset();
            return;
        }
        this.updateButtons();
    }
    
    next() {
        if (!this.running || this.currentIndex >= this.steps.length - 1) return;
        this.currentIndex++;
        this.render(this.steps[this.currentIndex]);
        this.updateButtons();
    }

    resetInternalState() {
        this.running = false;
        this.steps = [];
        this.currentIndex = 0;
        if(this.dom.overlay) this.dom.overlay.classList.remove('show');
    }

    reset() {
        this.resetInternalState();
        if (this.customResetFn) {
            this.customResetFn();
        }
        this.updateButtons();
    }

    updateButtons() {
        if (this.dom.startBtn) this.dom.startBtn.textContent = this.running ? "Reset" : "Start";
        if (this.dom.nextBtn) this.dom.nextBtn.disabled = !this.running || this.currentIndex >= this.steps.length - 1;
    }
    
    render(state) { /* To be implemented by child */ }
}

// --- MODULE 1: Monotonic Stack ---
function initMonotonicStack() {
    const module = new AnimationModule('ms_');
    module.dom.stackContainer = module.get('stack_container');
    module.dom.barContainer = module.get('bar_chart_container');
    module.dom.resultContainer = module.get('result_container');
    module.dom.actionDisplay = module.get('action_display');
    module.dom.overlay = module.get('overlay');
    
    const generateSteps = (inputValue) => {
        const nums = inputValue.split(',').map(s => parseInt(s.trim()));
        if (nums.some(isNaN)) throw new Error('Invalid number format');
        const n = nums.length;
        const result = new Array(n).fill(-1);
        const stack = []; const steps = [];
        const save = (i, msg, phase) => steps.push({ i, msg, phase, stack: [...stack], result: [...result] });

        save(-1, "Start from the right.", 'initial');
        for (let i = n - 1; i >= 0; i--) {
            save(i, `Processing element ${nums[i]} at index ${i}.`, 'iterate');
            while (stack.length > 0 && nums[i] >= nums[stack[stack.length - 1]]) {
                const poppedIdx = stack.pop();
                save(i, `Current ${nums[i]} >= stack top ${nums[poppedIdx]}. Pop ${poppedIdx}.`, 'pop');
            }
            if (stack.length > 0) {
                result[i] = nums[stack[stack.length - 1]];
                save(i, `Stack top ${result[i]} is next greater element.`, 'found');
            } else {
                save(i, `Stack is empty. No greater element.`, 'not_found');
            }
            stack.push(i);
            save(i, `Push index ${i} onto the stack.`, 'push');
        }
        save(-1, "Finished!", 'finish');
        return steps;
    };

    module.render = (state) => {
        const nums = module.dom.input.value.split(',').map(s => parseInt(s.trim()));
        const maxNum = Math.max(...nums, 1);
        module.dom.actionDisplay.textContent = state.msg;

        module.dom.barContainer.innerHTML = '';
        module.dom.resultContainer.innerHTML = '';
        nums.forEach((val, i) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'ms-bar-wrapper';
            const bar = document.createElement('div');
            bar.className = 'ms-bar'; bar.textContent = val;
            bar.style.height = `${(val / maxNum) * 150}px`;
            if (i === state.i) bar.classList.add('current');
            if (state.stack.includes(i)) bar.classList.add('stack');
            wrapper.appendChild(bar);
            wrapper.innerHTML += `<div class="bar-index">${i}</div>`;
            module.dom.barContainer.appendChild(wrapper);

            const resCell = document.createElement('div');
            resCell.className = 'res-cell';
            resCell.innerHTML = `<div class="res-value">${state.result[i]}</div><div class="res-index">${i}</div>`;
            if (state.result[i] !== -1) resCell.classList.add('filled');
            module.dom.resultContainer.appendChild(resCell);
        });
        
        module.dom.stackContainer.innerHTML = '';
        state.stack.forEach(idx => {
            const item = document.createElement('div');
            item.className = 'stack-item'; item.textContent = `Idx ${idx} (${nums[idx]})`;
            module.dom.stackContainer.appendChild(item);
        });
        
        if(state.phase === 'finish') module.dom.overlay.classList.add('show');
    };
    
    const resetFn = () => {
        module.dom.actionDisplay.textContent = "Enter numbers and click 'Start'.";
        module.dom.stackContainer.innerHTML = '';
        module.dom.barContainer.innerHTML = '';
        module.dom.resultContainer.innerHTML = '';
    };

    module.setupControls(generateSteps, resetFn);
}

// --- MODULE 2: Valid Parentheses ---
function initValidParentheses() {
    const module = new AnimationModule('vp_');
    module.dom.stackContainer = module.get('stack_container');
    module.dom.stringDisplay = module.get('string_display');
    module.dom.actionDisplay = module.get('action_display');
    module.dom.overlay = module.get('overlay');
    module.dom.finalResult = module.get('final_result');
    
    const generateSteps = (s) => {
        const stack = []; const steps = [];
        const map = { "(": ")", "{": "}", "[": "]" };
        const save = (i, msg, phase, isValid = null) => steps.push({ i, msg, phase, stack: [...stack], isValid });

        save(-1, "Start processing the string.", 'initial');
        for (let i = 0; i < s.length; i++) {
            const char = s[i];
            if (map[char]) {
                stack.push(char);
                save(i, `Found opening bracket '${char}'. Pushing to stack.`, 'push');
            } else if (Object.values(map).includes(char)) {
                if (stack.length === 0) {
                    save(i, `Found closing bracket '${char}' but stack is empty. Invalid.`, 'finish', false); return steps;
                }
                const lastOpen = stack.pop();
                if (map[lastOpen] !== char) {
                    save(i, `Mismatch! Closing '${char}' does not match opening '${lastOpen}'. Invalid.`, 'finish', false); return steps;
                }
                save(i, `Found closing bracket '${char}'. It matches '${lastOpen}'. Popping.`, 'pop');
            } else {
                 save(i, `Skipping character '${char}'.`, 'skip');
            }
        }
        if (stack.length > 0) {
            save(-1, "End of string, but stack is not empty. Invalid.", 'finish', false);
        } else {
            save(-1, "End of string and stack is empty. Valid!", 'finish', true);
        }
        return steps;
    };
    
    module.render = (state) => {
        module.dom.actionDisplay.textContent = state.msg;
        
        module.dom.stringDisplay.innerHTML = '';
        module.dom.input.value.split('').forEach((char, i) => {
            const charBox = document.createElement('div');
            charBox.className = 'char-box';
            if(i === state.i) charBox.classList.add('highlight');
            charBox.textContent = char;
            module.dom.stringDisplay.appendChild(charBox);
        });

        module.dom.stackContainer.innerHTML = '';
        state.stack.forEach(char => {
            const item = document.createElement('div');
            item.className = 'stack-item vp-stack-item';
            if (char === '(') item.classList.add('round');
            else if (char === '{') item.classList.add('curly');
            else if (char === '[') item.classList.add('square');
            item.textContent = char;
            module.dom.stackContainer.appendChild(item);
        });

        if (state.phase === 'finish') {
            module.dom.finalResult.textContent = state.isValid ? 'Result: VALID' : 'Result: INVALID';
            module.dom.finalResult.style.color = state.isValid ? '#2ecc71' : '#e74c3c';
            module.dom.overlay.classList.add('show');
        }
    };
    
    const resetFn = () => {
        module.dom.actionDisplay.textContent = "Enter a string of brackets and click 'Start'.";
        module.dom.stackContainer.innerHTML = '';
        module.dom.stringDisplay.innerHTML = '';
    };
    
    module.setupControls(generateSteps, resetFn);
}

// --- MODULE 3: Basic Calculator ---
function initBasicCalculator() {
    const module = new AnimationModule('bc_');
    module.dom.stackContainer = module.get('stack_container');
    module.dom.stringDisplay = module.get('string_display');
    module.dom.actionDisplay = module.get('action_display');
    module.dom.resultVal = module.get('result_val');
    module.dom.signVal = module.get('sign_val');
    module.dom.numVal = module.get('num_val');
    module.dom.evalZone = module.get('evaluation_zone');
    module.dom.overlay = module.get('overlay');
    module.dom.finalResult = module.get('final_result');
    
    const generateSteps = (s) => {
        const steps = []; const stack = [];
        let result = 0, num = 0, sign = 1;
        const save = (i, msg, phase, evalText = null) => steps.push({ i, msg, phase, stack: [...stack], result, sign, num, evalText });

        save(-1, "Begin calculation.", 'initial');
        for (let i = 0; i < s.length; i++) {
            const c = s.charAt(i);
            if (c >= '0' && c <= '9') {
                num = num * 10 + (c - '0');
                save(i, `Parsing digit '${c}'.`, 'digit');
            } else if (c === '+' || c === '-') {
                result += sign * num;
                save(i, `Operator '${c}'. Evaluating term.`, 'op', `result += ${sign} * ${num}`);
                sign = (c === '+') ? 1 : -1; num = 0;
                save(i, `Resetting sign to ${sign} and num to 0.`, 'op_reset');
            } else if (c === '(') {
                stack.push(result); stack.push(sign);
                save(i, `Start '('. Saving state [${result}, ${sign}]`, 'paren_open');
                result = 0; sign = 1; num = 0;
                save(i, `Resetting state for inner scope.`, 'paren_reset');
            } else if (c === ')') {
                result += sign * num;
                save(i, `End ')'. Evaluating inner term.`, 'paren_close', `result += ${sign} * ${num}`);
                result *= stack.pop(); // sign
                result += stack.pop(); // result
                num = 0; sign = 1;
                save(i, `Popped and applied outer state.`, 'paren_pop');
            }
        }
        result += sign * num;
        save(-1, `Final calculation.`, 'final', `result += ${sign} * ${num}`);
        save(-1, "Finished!", 'finish', `Result: ${result}`);
        return steps;
    };

    module.render = (state) => {
        module.dom.actionDisplay.textContent = state.msg;
        module.dom.resultVal.textContent = state.result;
        module.dom.signVal.textContent = state.sign;
        module.dom.numVal.textContent = state.num;

        module.dom.stringDisplay.innerHTML = '';
        module.dom.input.value.split('').forEach((char, i) => {
            const charBox = document.createElement('div');
            charBox.className = 'char-box';
            if(i === state.i) charBox.classList.add('highlight');
            charBox.textContent = char;
            module.dom.stringDisplay.appendChild(charBox);
        });
        
        module.dom.stackContainer.innerHTML = '';
        state.stack.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'stack-item';
            div.classList.add((i % 2 === 0) ? 'result' : 'sign');
            div.textContent = item;
            module.dom.stackContainer.appendChild(div);
        });

        if (state.evalText) {
            module.dom.evalZone.style.display = 'block';
            module.dom.evalZone.textContent = state.evalText;
        } else {
            module.dom.evalZone.style.display = 'none';
        }

        if(state.phase === 'finish') {
            module.dom.finalResult.textContent = state.result;
            module.dom.overlay.classList.add('show');
        }
    };
    
    const resetFn = () => {
        module.dom.actionDisplay.textContent = "Enter an expression and click 'Start'.";
        module.dom.stackContainer.innerHTML = '';
        module.dom.stringDisplay.innerHTML = '';
        module.dom.evalZone.style.display = 'none';
        module.dom.resultVal.textContent = 0;
        module.dom.signVal.textContent = 1;
        module.dom.numVal.textContent = 0;
    };
    
    module.setupControls(generateSteps, resetFn);
}

// --- MODULE 4: Iterative DFS ---
function initFlattenNestedList() {
    const module = new AnimationModule('fnli_');
    module.dom.inputContainer = module.get('input_list_container');
    module.dom.stackContainer = module.get('stack_container');
    module.dom.resultContainer = module.get('result_container');
    module.dom.actionDisplay = module.get('action_display');
    module.dom.overlay = module.get('overlay');

    const generateSteps = (inputValue) => {
        const nestedList = JSON.parse(inputValue);
        if (!Array.isArray(nestedList)) throw new Error();
        const steps = [];
        const result = [];
        const stack = [...nestedList].reverse();
        const save = (msg, phase) => steps.push({ msg, phase, stack: JSON.parse(JSON.stringify(stack)), result: [...result] });

        save("Starting with reversed list on stack.", 'initial');
        while (stack.length > 0) {
            const top = stack.pop();
            save(`Popping ${JSON.stringify(top)} from stack.`, 'pop');
            if (Number.isInteger(top)) {
                result.push(top);
                save(`It's an integer. Adding to result.`, 'add');
            } else if (Array.isArray(top)) {
                save(`It's a list. Pushing its reversed contents to stack.`, 'push_list');
                stack.push(...[...top].reverse());
            }
        }
        save("Stack is empty. Finished.", 'finish');
        return steps;
    };
    
    const buildListDOM = (list, parentElement) => {
        const ul = document.createElement('ul');
        list.forEach((item) => {
            const li = document.createElement('li');
            li.className = 'fnli-list-item';
            if (Array.isArray(item)) {
                li.classList.add('is-list');
                buildListDOM(item, li);
            } else { li.classList.add('is-int'); li.textContent = item; }
            ul.appendChild(li);
        });
        parentElement.appendChild(ul);
    }
    
    module.render = (state) => {
        module.dom.actionDisplay.textContent = state.msg;
        
        module.dom.resultContainer.innerHTML = '';
        state.result.forEach(val => {
            const cell = document.createElement('div');
            cell.className = 'res-cell filled';
            cell.innerHTML = `<div class="res-value">${val}</div>`;
            module.dom.resultContainer.appendChild(cell);
        });

        module.dom.stackContainer.innerHTML = '';
        state.stack.forEach(item => {
            const div = document.createElement('div');
            div.className = 'stack-item';
            div.textContent = JSON.stringify(item);
            module.dom.stackContainer.appendChild(div);
        });

        if(state.phase === 'finish') module.dom.overlay.classList.add('show');
    };

    const customStartFn = () => {
        module.start(() => {
            const val = module.dom.input.value;
            const parsedList = JSON.parse(val);
            module.dom.inputContainer.innerHTML = '';
            buildListDOM(parsedList, module.dom.inputContainer);
            return generateSteps(val);
        });
    };

    const resetFn = () => {
        module.dom.actionDisplay.textContent = "Enter a nested list and click 'Start'.";
        module.dom.stackContainer.innerHTML = '';
        module.dom.inputContainer.innerHTML = '';
        module.dom.resultContainer.innerHTML = '';
    };

    module.setupControls(null, resetFn, customStartFn);
}
</script>
</body>
</html>